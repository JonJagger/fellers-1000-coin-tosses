<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Feller's coin tosses</title>    
    <script src="jquery-1.8.3.js"           type="text/javascript"></script>
    <script src="jquery.flot.js"            type="text/javascript" ></script>
    <script src="jquery.flot.axislabels.js" type="text/javascript" ></script>
    <script src="jquery-ui.js"              type="text/javascript" ></script>
    <script src="jstat-core.js"             type="text/javascript" ></script>
    <script src="jstat-vector.js"           type="text/javascript" ></script>
    <link   href="jquery-ui.css"            type="text/css" rel="stylesheet">

    <script type="text/javascript">

        // Code to investigate Feller's walk
        //
        // Image you have a fair coin, and you flip it 1000 times,
        // adding 1 or subtracting 1 each time you flip either a head
        // or a tail respectively. How do you think the cumulative total
        // will behave as the number of coin flips progresses from 1 to 1000?
        //
        // For the code below it is important to understand that...
        // *** if the number of steps is even the total is always even.
        // *** if the number of steps is odd  the total is always odd.
        //
        // Suppose the number of steps in a walk == 4. Possibilities are:
        //     0H 4T == 0-4 == -4
        //     1H 3T == 1-3 == -2
        //     2H 2T == 2-2 ==  0
        //     3H 1T == 3-1 == +2
        //     4H 0T == 4-0 == +4
        //
        // Suppose the number of steps in a walk == 5. Possibilities are:
        //     0H 5T == 0-5 == -5
        //     1H 4T == 1-4 == -3
        //     2H 3T == 2-3 == -1
        //     3H 2T == 3-2 == +1
        //     4H 1T == 4-1 == +3
        //     5H 0T == 5-0 == +5
        //        
        // http://jonjagger.blogspot.co.uk/2013/01/fellers-walk.html
        
        var NUMBER_OF_WALKS = 5000;
        var FLIPS_PER_WALK = 1000;
        var WALKS_PER_PLOT = 100;
        
        //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // What are the effects of adding feedback, of nudging
        // the total back towards zero every so often...?
        // To get a feedback nudge every Nth throw (on average)
        // set FEEDBACK to N. To get no feedback set N to zero.
        
        var FEEDBACK = undefined;
        
        function setFeedback(n) {
            FEEDBACK = n;
            ordinals = makeOrdinals(n);
        }
        
        Array.prototype.shuffle = function() {
            // Fischer-Yates shuffle (after Ronald Fisher)
            // http://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle
            var i = this.length, j, temp;
            if (i === 0) {
                return this;
            }
            while ( --i ) {
               j = Math.floor( Math.random() * ( i + 1 ) );
               temp = this[i];
               this[i] = this[j];
               this[j] = temp;
            }
            return this;
        }
        
        var actualFeedbackCount = 0;
        
        function feedback() {
            // Must be independent of the walk number
            ordinals.shuffle();
            return (ordinals !== [ ] && ordinals[0] === 0);
        }
                
        function expectedFeedback() {
            return (FEEDBACK === 0)
                ? 'none'
                : FEEDBACK + 'th throws';            
        }
        
        function actualFeedback(n) {
            return (actualFeedbackCount === 0)
                ? 'none'
                : (1 / (actualFeedbackCount / (FLIPS_PER_WALK * n))).toFixed(2);                
        }
        
        function makeOrdinals(n) {
            var array = [ ];
            for (var i = 0; i < n; i++) {
                array.push(i);
            }
            return array;            
        }
        
        var ordinals = undefined;
                
        var NEG = 0;
        var POS = 1;
        
        var flotCounts = function() {
            // flot.js requires an array of data-points
            // But javascript cannot use negative array indexes
            // So I use one array for -ve x-values and
            // one array for +ve x-values and convert them
            // back using countPlots()
            var array =  [ ];
            array[NEG] = [ ];
            array[POS] = [ ];
            return array;
        };
        
        //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // Counts of cumulative total after 
        // N coin flips where N=50,100,500
        var counts_50    = flotCounts(); 
        var counts_100   = flotCounts(); 
        var counts_1000  = flotCounts();         
        
        function doOneWalk() {            
            var HEAD = +1;
            var TAIL = -1;
            var walk = [ ];
            var total = 0;
            for (var flip = 1; flip < FLIPS_PER_WALK+1; flip++) {
                if (feedback()) {
                    // I must _not_ tweak the feedback like this:
                    //    if (total < 0)
                    //      total += 1;
                    //    if (total > 0)
                    //      total -= 1;
                    // If I do this, then for the case when total === 0
                    // I will _not_ do a head+1 or a tail-1 at all.
                    // This will alter the final total to be odd when
                    // its normally even (or vice versa). See ***
                    // Thus I will get an outlier in the series data.
                    actualFeedbackCount += 1;                    
                    total += (total < 0) ? HEAD : TAIL;
                } else {
                    total += (Math.random() < 0.5) ? HEAD : TAIL;
                }
                walk.push([flip,total]);
                
                // To get a smooth plot with values for both 
                // odd and even totals I need totals for walks
                // whose length are both odd and even. See ***
                
                if (flip === 49 || flip === 50) {
                    recordTotal(counts_50, total);
                }
                if (flip === 99 || flip === 100) {
                    recordTotal(counts_100, total);
                }
                if (flip === 999 || flip === 1000) {
                    recordTotal(counts_1000, total);
                }
            }
            return walk;
        }       

        function recordTotal(array, total) {            
            var NP = (total < 0) ? NEG : POS;
            var absTotal = Math.abs(total);
            if (array[NP][absTotal] === undefined) {
                array[NP][absTotal] = [total,0];
            }
            array[NP][absTotal][1] += 1;            
        }

        function getCountPlots() {
            return [ 
                { label: "after ~50 flips",   data: countPlot(counts_50)   },
                { label: "after ~100 flips",  data: countPlot(counts_100)  },
                { label: "after ~1000 flips", data: countPlot(counts_1000) },
            ];
        }
        
        function countPlot(counts) {            
            var probs = [ [ ], [ ] ];
            var neg = counts[NEG];
            for (var at in neg) {
                if (neg[at] != undefined) {
                    probs[NEG][at] = neg[at];
                }
            }
            var pos = counts[POS];
            for (var at in pos) {
                if (pos[at] != undefined) {
                    probs[POS][at] = pos[at];
                }
            }
            var all = probs[NEG].reverse().concat(probs[POS]);
            // all has lots of null entries because the array indexes
            // are not contiguous. plot cannot handle nulls
            var plot = [ ];
            for (var at = 0; at < all.length; at++) {
                if (all[at] != undefined) {
                    plot.push(all[at]);
                }
            }            
            return plot;
        }

        function getCountPlotOptions() {                            
            return {
                legend: {
                    position: "nw"
                },                                
                xaxis: {
                    axisLabel: "count&uarr; &larr;total&rarr;",
                    position: "bottom",
                },
                series: {
                    lines: {
                        show: true
                    },
                    points: {
                        show: false,
                    }
                }
            };                        
        }
        
        function getWalkPlotOptions(walk) {
            return {
                legend: {
                    position: "nw"
                },                                
                xaxis: {
                    axisLabel: "total&uarr; flip&rarr;", 
                    position: "bottom",
                    min: 0,
                    max: walk.length
                },
                yaxis: {
                    tickDecimals: 0,
                    min: -50,
                    max: 50                    
                },
                series: {
                    color: "green",
                    lines: {
                        show: true
                    },
                    points: {
                        show: false,
                    }
                }
            };            
        }
        
        function countAtTotalZero(array) {
            var count;
            for (var i=0; i != array.length; i++) {
                if (array[i][0] === 0) {
                    return array[i][1];
                }
            }
            return '?';
        }
        
        function rangeOfTotals(array) {
            var min = array[0][0];
            var max = array[array.length-1][0];
            return '[' + min + ',' + max + ']';
        }
        
        function stdDev(array) {
            return jStat.stdev([1,2,3,4]).toFixed(2);
        }
        
        function walkLabel(n) {
            var percentDone = (n / NUMBER_OF_WALKS * 100).toFixed(0);
            return n+"th Walk (" + percentDone + "%)";
        }
        
        function display(n,walk) {
            var plot;
            $.plot($("#fellers-walk"),
                   [ { label: walkLabel(n), data: walk } ],
                   getWalkPlotOptions(walk));                                                        
            $.plot($("#fellers-counts"),
                   plot = getCountPlots(),
                   getCountPlotOptions());
            
            $('.feedback #expected').html(expectedFeedback());
            $('.feedback #actual').html(actualFeedback(n));
            
            $('.stats #flips_50 #total').html(countAtTotalZero(plot[0].data));
            $('.stats #flips_100 #total').html(countAtTotalZero(plot[1].data));
            $('.stats #flips_1000 #total').html(countAtTotalZero(plot[2].data));
            
            $('.stats #flips_50 #range').html(rangeOfTotals(plot[0].data));
            $('.stats #flips_100 #range').html(rangeOfTotals(plot[1].data));
            $('.stats #flips_1000 #range').html(rangeOfTotals(plot[2].data));
            
            $('.stats #flips_50 #std_dev').html(stdDev(plot[0].data));            
            $('.stats #flips_100 #std_dev').html(stdDev(plot[1].data));            
            $('.stats #flips_1000 #std_dev').html(stdDev(plot[2].data));            
        }
        
        function makeDialogHtml() {
            return '' +
                '<table>' +
                  '<tr>' +
                    '<td>' +
                      '<label>Feedback every</label>' +
                    '</td>' +
                    '<td>' +  
                      '<input type="text"' +
                             'style="width:5em;"' +
                             'value="' + FEEDBACK + '"' +
                             'id="feedback">' +
                       'th flip' +
                    '</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<td>' +
                      '<label>Number of Walks</label>' +
                    '</td>' +
                    '<td>' +
                      '<input type="text"' +
                             'style="width:5em;"' +
                             'value="' + NUMBER_OF_WALKS + '"' +
                             'id="no_of_walks">' +
                    '</td>' +
                  '</tr>' +                      
                '</table>';            
        }
        
        function setParameters(html) {
            //TODO: check input
            setFeedback(parseInt($('#feedback',html).val()));
            NUMBER_OF_WALKS = parseInt($('#no_of_walks',html).val());            
        }
        
        function setupAndRunSimulation() {
            var html = $(makeDialogHtml());
            var setup = html.dialog({	  
                title: "Feller's 1000 coin-flip walk",
                autoOpen: false,
                width: 500,
                modal: true,
                buttons: {
                  ok: function() {
                    setParameters(html);
                    runSimulation();
                    $(this).dialog('close');
                  }
                }
              });
            setup.dialog('open');
        }
        
        function runSimulation() {
            $('.stats').show();            
            // Can't use for-loop (the plots don't appear?!)
            var n = 0;
            var fid = setInterval(
                function() {
                    if (n++ === NUMBER_OF_WALKS) {
                        clearInterval(fid);
                    } else {
                        var walk = doOneWalk();
                        if (n % WALKS_PER_PLOT === 0) {
                            display(n, walk);
                        }                                    
                    }                   
                },
                0);            
        }
        
        $(document).ready(function () {
            //TODO: add button to run again
            //TODO: calc and show variance's
            setFeedback(0);
            $('.stats').hide();
            setupAndRunSimulation();
        });
        
    </script>
    
    <style type="text/css">
    #fellers-walk   { width: 1100px; height: 290px; }
    #fellers-counts { width: 1100px; height: 290px; }
    .stats, .feedback { font-size: 0.8em; }
    table {
        display: inline-block;
        border-collapse: collapse;
	    border-spacing: 0;
    }
    .stats td, .stats th, .feedback td {
        border: solid 1px black;
        padding: 0.25em;
    }
    </style>      
</head>
<body>                
    <table>
        <tr>
            <td><div id="fellers-walk"></div></td>
        </tr>
        <tr>
            <td><div id="fellers-counts"></div></td>
        </tr>
    </table>
    
    <table class="stats">
        <tr>
            <th>~flips</th>
            <th>count[total=0]</th>
            <th>range</th>
            <th>std-dev</th>
        </tr>
        <tr id="flips_50">
            <th>50</th>
            <td><span id="total"></span></td>
            <td><span id="range"></span></td>
            <td><span id="std_dev"></span></td>
        </tr>
        <tr id="flips_100">
            <th>100</th>
            <td><span id="total"></span></td>
            <td><span id="range"></span></td>
            <td><span id="std_dev"></span></td>
        </tr>
        <tr id="flips_1000">
            <th>1000</th>
            <td><span id="total"></span></td>
            <td><span id="range"></span></td>
            <td><span id="std_dev"></span></td>            
        </tr>
    </table>

    <table class="feedback">
        <caption><b>feedback</b></caption>
        <tr>
            <td>expected</td>
            <td><span id="expected"></span></td>
        </tr>
        <tr>
            <td>actual</td>
            <td><span id="actual"></span></td>
        </tr>
    </table>
    
</body>
</html>
